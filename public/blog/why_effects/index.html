<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Why Algebraic Effects?</title>
<meta name="author" content="Jake Fecher" />




<meta name="keywords" content="ante, programming, language, antelang, lang">


<meta name="description" content="">

<meta name="generator" content="Hugo 0.89.0-DEV" />


<link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>


<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.11.2/css/all.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link href="/css/animate.css" rel="stylesheet">



  <link href="/css/style.red.css" rel="stylesheet" id="theme-stylesheet">



<link href="/css/custom.css?1756072605" rel="stylesheet">



  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->



<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />


<link href="/css/owl.carousel.css" rel="stylesheet">
<link href="/css/owl.theme.css" rel="stylesheet">


<link rel="alternate" href="https://antelang.org/index.xml" type="application/rss+xml" title="Ante">








<meta property="og:locale" content="en_us">
<meta property="og:site_name" content="Ante">
<meta property="og:title" content="Why Algebraic Effects?">
<meta property="og:type" content="article">
<meta property="og:url" content="https://antelang.org/blog/why_effects/" />
<meta property="og:description" content="">
<meta property="og:image" content="https://antelang.org/img/banners/lanterns.jpg">
<meta property="og:image:type" content="image/jpg">



  <meta property="og:image:width" content="1260">
  <meta property="og:image:height" content="1260">


<meta property="og:updated_time" content="2025-05-21T00:00:00Z">

  
  
  <meta property="article:section" content="effects">
  
  
  <meta property="article:published_time" content="2025-05-21T00:00:00Z">
  <meta property="article:modified_time" content="2025-05-21T00:00:00Z">



<meta name="twitter:card" content="summary_large_image">

<meta name="twitter:title" content="Why Algebraic Effects?">

<meta name="twitter:image" content="https://antelang.org/img/banners/lanterns.jpg">

<meta name="twitter:description" content="">


      <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Why Algebraic Effects?</title>
  <meta name="author" content="" />

  <meta name="keywords" content="ante, programming, language, antelang, lang">	
  <meta name="description" content="For exploring algebraic effects, safe shared mutability, and other novel features">

  <meta name="generator" content="Hugo 0.89.0-DEV" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="https://antelang.org/css/animate.css" rel="stylesheet">

  
  
    <link href="https://antelang.org/css/style.red.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="https://antelang.org/css/custom.css" rel="stylesheet">
 
  
  <link rel="stylesheet" href="https://antelang.org/css/syntax.css">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="https://antelang.org/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="https://antelang.org/img/apple-touch-icon.png" />
  

  <link href="https://antelang.org/css/owl.carousel.css" rel="stylesheet">
  <link href="https://antelang.org/css/owl.theme.css" rel="stylesheet">

  <link rel="alternate" href="https://antelang.org/index.xml" type="application/rss+xml" title="Ante">

  
  <meta property="og:title" content="Why Algebraic Effects?" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://antelang.org/blog/why_effects//" />
  <meta property="og:image" content="" />

  </head>

  <body>
    <div id="all">
        

        

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="https://antelang.org/">
                    <img src="https://antelang.org/img/ante_white.svg" width="90rem" alt="Why Algebraic Effects?" class="hidden-xs hidden-sm">
                    <img src="https://antelang.org/img/ante_white.svg" width="90rem" alt="Why Algebraic Effects?" class="visible-xs visible-sm">
                    <span class="sr-only">Why Algebraic Effects? - go to homepage</span>
                </a>
                
<div class="navbar-buttons">
        <div class="navbar-collapse collapse" id="navigation">
            <ul class="nav navbar-nav navbar-right">
            
            <li class="dropdown">
                <a href="https://antelang.org//docs/language">Tour</a>
            </li>
            <li class="dropdown">
                <a href="https://antelang.org//docs/ideas">Ideas</a>
            </li>
            <li class="dropdown">
                <a href="https://antelang.org//docs/roadmap">Roadmap</a>
            </li>
            <li class="dropdown">
                <a href="https://antelang.org//blog">Blog</a>
            </li>

            <li class="dropdown">
                <a href="https://github.com/jfecher/ante"><i class="fa fa-15x fa-github"></i></a>
            </li>
            <li class="dropdown">
                <a href="https://reddit.com/r/ante"><i class="fab fa-15x fa-reddit"></i></a>
            </li>
            <li class="dropdown">
                <a href="https://discord.gg/NPJncGBAws"><i class="fab fa-15x fa-discord"></i></a>
            </li>
            <li class="dropdown">
                <a href="https://antelang.org//index.xml"><i class="fa fa-15x fa-rss"></i></a>
            </li>

            </ul>
        </div>
        <button type="button" class="navbar-toggle btn-template-main" onclick="document.getElementById('navigation').classList.toggle('collapse')">
    <span class="sr-only">Toggle Navigation</span>
        <i class="fa fa-align-justify"></i>
    </button>
</div>

            </div>
            

            
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    





        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Why Algebraic Effects?</h1>
            </div>
        </div>
    </div>
</div>

        <div id="content">
            <div class="container" id="post-container">
                <div class="row">
                    

                    <div class="col-md-3">
                        
                        <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>Contents</h1>
    </div>

    
    
    
    
    <div class="table-of-contents toc bd-callout">
        
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#why-algebraic-effects">
                        <li>Why Algebraic Effects</li>
                    </a>
                    
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#a-note-on-syntax-and-semantics">
                        <li>A Note on Syntax and Semantics</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#user-defineable-control-flow">
                        <li>User-defineable control-flow</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#as-an-abstraction">
                        <li>As an Abstraction</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#cleaner-apis">
                        <li>Cleaner APIs</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                        <ul class="toc-h3">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#as-a-substitute-for-globals">
                        <li>As a substitute for globals</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                        <ul class="toc-h3">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#writing-in-a-direct-style">
                        <li>Writing in a Direct Style</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#guaranteeing-purity">
                        <li>Guaranteeing Purity</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                        <ul class="toc-h3">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#replayability">
                        <li>Replayability</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
            
            
                
                    
                    
                    
                        <ul class="toc-h1">
                    
                        <ul class="toc-h2">
                    
                        <ul class="toc-h3">
                    
                    
                    
                    
                    <a href="/blog/why_effects/#capability-based-security">
                        <li>Capability-based Security</li>
                    </a>
                    
                    
                        </ul>
                    
                        </ul>
                    
                        </ul>
                    
                
            
        
    </div>
    


    
  </div>
</div>

                        
                    </div>
                    

                    <div class="col-md-9" id="blog-post">

                        
                          <p class="text-muted text-uppercase mb-small text-right">
                            
			      By <a href="/authors/jake-fecher">Jake Fecher</a>
                            
                            
                            
                              
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                                  
                              
                              2025-05-21
                            
                          </p>
                        

                        <div id="post-content">
                          <h1 id="why-algebraic-effects">Why Algebraic Effects</h1>
<p>Algebraic effects<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> (a.k.a. effect handlers) are a very useful up-and-coming feature that I personally think will see a huge surge in popularity in the programming
languages of tomorrow. They&rsquo;re one of the core features of Ante, as well as being the focus of many research
languages including <a href="https://koka-lang.github.io/koka/doc/index.html">Koka</a>, <a href="https://effekt-lang.org/">Effekt</a>, <a href="https://www.eff-lang.org/">Eff</a>,
and <a href="https://flix.dev/">Flix</a>. However, while many articles or documentation snippets try to explain <em>what</em> effect handlers are (including
<a href="/docs/language#algebraic-effects">Ante&rsquo;s own documentation</a>), few really go in-depth on <em>why</em> you would want to use them.
In this post I&rsquo;ll explain exactly that and will include as complete a list as possible on all the use-cases of algebraic effects.</p>
<h2 id="a-note-on-syntax-and-semantics">A Note on Syntax and Semantics</h2>
<p>I&rsquo;ll be using Ante pseudocode for much of this article. If you&rsquo;re not familiar with effect handlers or Ante I encourage you to read the documentation link
above or read from any of the other effectful languages for a good head start! But I recognize it&rsquo;s hard to get buy-in to learn something before showing
why it is useful first (hence this blog post!). So I&rsquo;ll give a quick elevator pitch on a good mental model to think about effects.</p>
<p>You can think of algebraic effects essentially as exceptions that you can resume. You can declare an effect function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">SayMessage</span> <span class="k">with</span>
    <span class="c1">// This effect function takes a Unit type and returns a Unit type.</span>
    <span class="c1">// Note that `Unit` is roughly the same as `void` in imperative languages.</span>
    <span class="c1">// There are differences between them but none that are relevant here.</span>
    <span class="n">say_message</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span>
</code></pre></div><p>You can &ldquo;throw&rdquo; an effect by calling the function, and the function you&rsquo;re in must declare it can use that effect similar to checked exceptions:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">foo</span> <span class="p">()</span> <span class="k">can</span> <span class="kt">SayMessage</span> <span class="ow">=</span>
    <span class="n">say_message</span> <span class="p">()</span>
    <span class="mi">42</span>
</code></pre></div><p>And you can &ldquo;catch&rdquo; effects with a <code>handle</code> expression (think of these as <code>try/catch</code> expressions):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">handle</span> <span class="n">foo</span> <span class="p">()</span>
<span class="o">|</span> <span class="n">say_message</span> <span class="p">()</span> <span class="ow">-&gt;</span>
    <span class="n">print</span> <span class="s">&#34;Hello World!&#34;</span>  <span class="c1">// print out Hello World!</span>
    <span class="k">resume</span> <span class="p">()</span>             <span class="c1">// then resume the computation, returning 42</span>
</code></pre></div><p>If you have further questions I again encourage you to read <a href="/docs/language#algebraic-effects">some documentation</a> on effects, but now
that we can recognize effects when they&rsquo;re used I&rsquo;ll get into why exactly the idea of exceptions-you-can-resume are so useful!</p>
<hr>
<h2 id="user-defineable-control-flow">User-defineable control-flow</h2>
<p>The most common reason you&rsquo;ll hear for why to have effect handlers is that they are a single language feature which
allow for implementing what would normally be multiple separate language features (generators, exceptions, async, coroutines, etc)
as libraries. Moreover, they solve the <a href="https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/">what color is your function</a>
problem by making functions polymorphic over effects. For example, a <code>map</code> function for vectors (growable arrays) can be written once:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">map</span> <span class="p">(</span><span class="n">input</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span> <span class="k">can</span> <span class="n">e</span><span class="p">)</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">b</span> <span class="k">can</span> <span class="n">e</span> <span class="ow">=</span>
    <span class="c1">// Implementation omitted!</span>
</code></pre></div><p>This function&rsquo;s signature says that the input function <code>f</code> can perform <em>any</em> effect(s) <code>e</code>, and that
<code>map</code> will perform those same effects <code>e</code>. So we can instantiate this with an <code>f</code> that prints to stdout,
an <code>f</code> that calls asynchronous functions, an <code>f</code> that yields elements into a stream, etc. Most languages
with effect handlers will let you omit the polymorphic effect variable <code>e</code> as well, giving us the
old, familiar signature for <code>map</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">map</span> <span class="p">(</span><span class="n">input</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">b</span> <span class="ow">=</span>
    <span class="c1">// Implementation omitted!</span>
</code></pre></div><p>Ok, back to the topic though. Effect handlers are cool because we can implement generators, exceptions, coroutines,
<a href="https://effekt-lang.org/docs/casestudies/ad">automatic differentiation</a>, and much more with them. Surely such
constructs are difficult to implement, requiring low-level knowledge though, right? Nope. Most of these are pretty
straightforward actually.</p>
<p>Let&rsquo;s consider exceptions. Remember when I described algebraic effects as resumeable exceptions? This actually works
pretty well as a hint on how to implement exceptions via effects. How do we do it? Just don&rsquo;t <code>resume</code> the effect when it is thrown:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Throw</span> <span class="n">a</span> <span class="k">with</span>
    <span class="n">throw</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">never_returns</span>

<span class="nf">safe_div</span> <span class="n">x</span> <span class="n">y</span> <span class="ow">=</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="n">throw</span> <span class="s">&#34;error: Division by zero!&#34;</span>

    <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>

<span class="c1">// Output: &#34;error: Division by zero!&#34;</span>
<span class="k">handle</span> 
    <span class="n">safe_div</span> <span class="mi">5</span> <span class="mi">0</span>
    <span class="n">print</span> <span class="s">&#34;successfully divided by zero&#34;</span> <span class="c1">// we never get to this point</span>
<span class="o">|</span> <span class="n">throw</span> <span class="n">msg</span> <span class="ow">-&gt;</span>
    <span class="n">print</span> <span class="n">msg</span>
</code></pre></div><p>How about something more advanced? Surely generators must be more difficult? Well, a little but the code still fits
onto a sticky note:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Yield</span> <span class="n">a</span> <span class="k">with</span>
    <span class="n">yield</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span>

<span class="nf">yield_all_elements_of_vec</span> <span class="p">(</span><span class="n">vec</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">a</span><span class="p">)</span><span class="o">:</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">Yield</span> <span class="n">a</span> <span class="ow">=</span>
    <span class="n">vec</span><span class="o">.</span><span class="n">for_each</span> <span class="k">fn</span> <span class="n">elem</span> <span class="ow">-&gt;</span>
        <span class="n">yield</span> <span class="n">elem</span>

<span class="c1">// To filter a generator we&#39;re going to take in a generator function to filter</span>
<span class="c1">// as well as a predicate to tell us which elements to keep</span>
<span class="nf">filter</span> <span class="p">(</span><span class="n">generator</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">Yield</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">predicate</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Bool</span><span class="p">)</span><span class="o">:</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">Yield</span> <span class="n">a</span> <span class="ow">=</span>
    <span class="k">handle</span> <span class="n">generator</span> <span class="p">()</span>
    <span class="o">|</span> <span class="n">yield</span> <span class="n">x</span> <span class="ow">-&gt;</span>
        <span class="c1">// when `generator` yields us an element, re-raise it if `predicate` returns true for it</span>
        <span class="k">if</span> <span class="n">predicate</span> <span class="n">x</span> <span class="k">then</span>
            <span class="n">yield</span> <span class="n">x</span>
        <span class="k">resume</span> <span class="p">()</span>  <span class="c1">// continue yielding elements</span>

<span class="c1">// Finally, lets add a helper function for applying a function to each yielded element</span>
<span class="nf">my_for_each</span> <span class="p">(</span><span class="n">generator</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">Yield</span> <span class="n">a</span><span class="p">)</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span><span class="p">)</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">=</span>
    <span class="k">handle</span> <span class="n">generator</span> <span class="p">()</span>
    <span class="o">|</span> <span class="n">yield</span> <span class="n">x</span> <span class="ow">-&gt;</span>
        <span class="n">f</span> <span class="n">x</span>
        <span class="k">resume</span> <span class="p">()</span>

<span class="c1">// Let&#39;s use it!</span>
<span class="nf">yield_all_elements_of_vec</span> <span class="p">(</span><span class="kt">Vec</span><span class="o">.</span><span class="n">of</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="c1">// `with` is sugar to apply effect handler functions</span>
    <span class="k">with</span> <span class="n">filter</span> <span class="p">(</span><span class="k">fn</span> <span class="n">x</span> <span class="ow">-&gt;</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">my_for_each</span> <span class="n">print</span>  <span class="c1">// prints 2 then 4</span>
</code></pre></div><p>You can similarly implement a cooperative scheduler with a <code>yield: Unit -&gt; Unit</code> effect which
yields control back to a handler which switches execution to another function. <a href="https://effekt-lang.org/docs/casestudies/scheduler">Here&rsquo;s an example</a>
of that in Effekt.</p>
<p>Basically, algebraic effects get you a lot of expressivity in your language, and as a bonus these different
effects compose well with each other. We&rsquo;ll get into this more later but algebraic effects composing well
is a huge usability win over other effect abstractions.</p>
<hr>
<h2 id="as-an-abstraction">As an Abstraction</h2>
<p>Okay, now that the really flashy stuff is out of the way I want to go over some less obvious benefits of algebraic effects.
Since discussion on effects can often seem like they&rsquo;re <em>only</em> for implementing generators, exceptions, async, etc., I want to
highlight that even if you don&rsquo;t personally care for these features, there are still good reasons to use algebraic effects
in your run of the mill business application.</p>
<p>One reason to use them in such an application is that effects can be used for <em>dependency injection</em>. Let&rsquo;s assume
we have code that touches a database:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">business_logic</span> <span class="p">(</span><span class="n">db</span><span class="o">:</span> <span class="kt">Database</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">I32</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div><p>This is all well and fine until we want to use a different database, restrict access to this database, or you know, actually
test these functions. What we can do is move the database to an effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Database</span> <span class="k">with</span>
    <span class="n">query</span><span class="o">:</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">DbResponse</span>

<span class="nf">business_logic</span> <span class="p">(</span><span class="n">x</span><span class="o">:</span> <span class="kt">I32</span><span class="p">)</span> <span class="k">can</span> <span class="kt">Database</span> <span class="ow">=</span>
    <span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">query</span> <span class="s">&#34;...&#34;</span>
    <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div><p>Now we can swap out the specific database used further up the call stack (let&rsquo;s say in <code>main</code>) with a different database,
or even with a mock database for testing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">mock_database</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Database</span><span class="p">)</span><span class="o">:</span> <span class="n">a</span> <span class="ow">=</span>
    <span class="k">handle</span> <span class="n">f</span> <span class="p">()</span>
    <span class="o">|</span> <span class="n">query</span> <span class="n">_msg</span> <span class="ow">-&gt;</span>
        <span class="c1">// Ignore the message and always return Ok</span>
        <span class="k">resume</span> <span class="kt">DbResponse</span><span class="o">.</span><span class="kt">Ok</span>

<span class="nf">test_business_logic</span> <span class="p">()</span> <span class="ow">=</span>
    <span class="c1">// Apply the `mock_database` handler to the rest of the function</span>
    <span class="k">with</span> <span class="n">mock_database</span>

    <span class="n">assert</span> <span class="p">(</span><span class="n">business_logic</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">business_logic</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">business_logic</span> <span class="mi">21</span> <span class="o">==</span> <span class="mi">42</span><span class="p">)</span>
    <span class="c1">// etc</span>
</code></pre></div><p>We can even redirect print outs into a string:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">output_messages</span> <span class="p">()</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Print</span> <span class="ow">=</span>
    <span class="n">print</span> <span class="s">&#34;Hello!&#34;</span>
    <span class="n">print</span> <span class="s">&#34;Not sure what to write here, honestly&#34;</span>
    <span class="mi">1234</span>

<span class="c1">// Collect `print` calls into a single string, separating each with newlines</span>
<span class="nf">print_to_string</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Print</span><span class="p">)</span><span class="o">:</span> <span class="n">a</span><span class="p">,</span> <span class="kt">String</span> <span class="k">can</span> <span class="kt">Print</span> <span class="ow">=</span>
    <span class="k">mut</span> <span class="n">all_messages</span> <span class="ow">=</span> <span class="s">&#34;&#34;</span>

    <span class="k">handle</span>
        <span class="n">result</span> <span class="ow">=</span> <span class="n">f</span> <span class="p">()</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">all_messages</span>
    <span class="o">|</span> <span class="n">print</span> <span class="n">msg</span> <span class="ow">-&gt;</span>
        <span class="n">all_messages</span> <span class="o">:=</span> <span class="n">all_messages</span> <span class="o">++</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span> <span class="o">++</span> <span class="n">msg</span>
        <span class="k">resume</span> <span class="p">()</span>

<span class="c1">// Now we can test `output_messages` without it printing to stdout</span>
<span class="nf">test_output_messages</span> <span class="p">()</span> <span class="ow">=</span>
    <span class="n">int</span><span class="p">,</span> <span class="n">messages</span> <span class="ow">=</span> <span class="n">output_messages</span> <span class="p">()</span> <span class="k">with</span> <span class="n">print_to_string</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">int</span> <span class="o">==</span> <span class="mi">1234</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">messages</span> <span class="o">==</span> <span class="s">&#34;Hello!</span><span class="se">\n</span><span class="s">Not sure what to write here, honestly&#34;</span><span class="p">)</span>
</code></pre></div><p>Or conditionally disable logging output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Log</span> <span class="k">with</span>
    <span class="n">log</span><span class="o">:</span> <span class="kt">LogLevel</span> <span class="ow">-&gt;</span> <span class="kt">String</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span>

<span class="k">type</span> <span class="kt">LogLevel</span> <span class="ow">=</span> <span class="o">|</span> <span class="kt">Error</span> <span class="o">|</span> <span class="kt">Warn</span> <span class="o">|</span> <span class="kt">Info</span>

<span class="kt">LogLevel</span><span class="o">.</span><span class="n">greater_than_or_equal</span> <span class="n">self</span> <span class="p">(</span><span class="n">other</span><span class="o">:</span> <span class="kt">LogLevel</span><span class="p">)</span><span class="o">:</span> <span class="kt">Bool</span> <span class="ow">=</span>
    <span class="k">match</span> <span class="n">self</span><span class="p">,</span> <span class="n">other</span>
    <span class="o">|</span> <span class="kt">Error</span><span class="p">,</span> <span class="n">_</span> <span class="ow">-&gt;</span> <span class="kc">true</span>
    <span class="o">|</span> <span class="kt">Warn</span><span class="p">,</span> <span class="p">(</span><span class="kt">Warn</span> <span class="o">|</span> <span class="kt">Info</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kc">true</span>
    <span class="o">|</span> <span class="kt">Info</span><span class="p">,</span> <span class="kt">Info</span> <span class="ow">-&gt;</span> <span class="kc">true</span>
    <span class="o">|</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">-&gt;</span> <span class="kc">false</span>

<span class="nf">foo</span> <span class="p">()</span> <span class="ow">=</span>
    <span class="n">log</span> <span class="kt">Info</span> <span class="s">&#34;Entering foo...&#34;</span>
    <span class="n">log</span> <span class="kt">Warn</span> <span class="s">&#34;foo is a fairly lazy example function&#34;</span>
    <span class="n">log</span> <span class="kt">Error</span> <span class="s">&#34;an error occurred!&#34;</span>

<span class="nf">log_handler</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Log</span><span class="p">)</span> <span class="p">(</span><span class="n">level</span><span class="o">:</span> <span class="kt">LogLevel</span><span class="p">)</span><span class="o">:</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Print</span> <span class="ow">=</span>
    <span class="k">handle</span> <span class="n">f</span> <span class="p">()</span>
    <span class="o">|</span> <span class="n">log</span> <span class="n">msg_level</span> <span class="n">msg</span> <span class="ow">-&gt;</span>
        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">greater_than_or_equal</span> <span class="n">msg_level</span> <span class="k">then</span>
            <span class="n">print</span> <span class="n">msg</span>
        <span class="k">resume</span> <span class="p">()</span>

<span class="nf">foo</span> <span class="p">()</span> <span class="k">with</span> <span class="n">log_handler</span> <span class="kt">Error</span>  <span class="c1">// outputs &#34;an error occurred!&#34;</span>
</code></pre></div><hr>
<h2 id="cleaner-apis">Cleaner APIs</h2>
<p>Algebraic effects can also make designing cleaner APIs easier. A common pattern in just about
any programming language is the use of a <code>Context</code> object which often needs to be passed to
most functions in the program or library. We can encode this pattern as an effect. All
we need are functions to <code>get</code> the context and to <code>set</code> it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Use</span> <span class="n">a</span> <span class="k">with</span>
    <span class="n">get</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span>
    <span class="n">set</span><span class="o">:</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span>
</code></pre></div><p>Most languages call this a state effect and it is generic over the type of state to use.</p>
<p>We can define a handler to provide the initial state value like so<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">state</span> <span class="p">(</span><span class="n">f</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Use</span> <span class="n">s</span><span class="p">)</span> <span class="p">(</span><span class="n">initial</span><span class="o">:</span> <span class="n">s</span><span class="p">)</span><span class="o">:</span> <span class="n">a</span> <span class="ow">=</span>
    <span class="k">mut</span> <span class="n">context</span> <span class="ow">=</span> <span class="n">initial</span>
    <span class="k">handle</span> <span class="n">f</span> <span class="p">()</span>
    <span class="o">|</span> <span class="n">get</span> <span class="p">()</span> <span class="ow">-&gt;</span> <span class="k">resume</span> <span class="n">context</span>  <span class="c1">// give the context to the caller of `get`</span>
    <span class="o">|</span> <span class="n">set</span> <span class="n">new_context</span> <span class="ow">-&gt;</span>
        <span class="n">context</span> <span class="o">:=</span> <span class="n">new_context</span>
        <span class="k">resume</span> <span class="p">()</span>
</code></pre></div><p>And we can use this to help clean up code that uses one or more context objects.
Let&rsquo;s imagine we have code which uses a vector internally and hands out references
to elements as indices into this vector. This would normally require passing around
the vector everywhere:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">type</span> <span class="kt">Strings</span> <span class="ow">=</span> <span class="n">vec</span><span class="o">:</span> <span class="kt">Vec</span> <span class="kt">String</span>
<span class="k">type</span> <span class="kt">StringKey</span> <span class="ow">=</span> <span class="n">index</span><span class="o">:</span> <span class="kt">Usz</span>

<span class="c1">// `!` is a mutable reference</span>
<span class="nf">push_string</span> <span class="p">(</span><span class="n">strings</span><span class="o">:</span> <span class="o">!</span><span class="kt">Strings</span><span class="p">)</span> <span class="p">(</span><span class="n">string</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span><span class="o">:</span> <span class="kt">StringKey</span> <span class="ow">=</span>
    <span class="n">key</span> <span class="ow">=</span> <span class="kt">StringKey</span> <span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">len</span> <span class="p">())</span>
    <span class="n">strings</span><span class="o">.</span><span class="n">push</span> <span class="n">string</span>
    <span class="n">key</span>

<span class="nf">get_string</span> <span class="p">(</span><span class="n">strings</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">Strings</span><span class="p">)</span> <span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="kt">StringKey</span><span class="p">)</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">String</span> <span class="ow">=</span>
    <span class="n">strings</span><span class="o">.</span><span class="n">get</span> <span class="n">key</span> <span class="o">|&gt;</span> <span class="n">unwrap</span>

<span class="nf">append_with_separator</span> <span class="p">(</span><span class="n">strings</span><span class="o">:</span> <span class="o">!</span><span class="kt">Strings</span><span class="p">)</span> <span class="p">(</span><span class="n">string1_key</span> <span class="n">separator</span> <span class="n">string2_key</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">string1</span> <span class="ow">=</span> <span class="n">get_string</span> <span class="n">strings</span> <span class="n">string1_key</span>
    <span class="n">string2</span> <span class="ow">=</span> <span class="n">get_string</span> <span class="n">strings</span> <span class="n">string2_key</span>
    <span class="n">push_string</span> <span class="n">strings</span> <span class="p">(</span><span class="n">string1</span> <span class="o">++</span> <span class="n">separator</span> <span class="o">++</span> <span class="n">string2</span><span class="p">)</span>

<span class="nf">example</span> <span class="p">(</span><span class="n">strings</span><span class="o">:</span> <span class="o">!</span><span class="kt">Strings</span><span class="p">)</span> <span class="ow">=</span>
    <span class="n">string1</span> <span class="ow">=</span> <span class="n">push_string</span> <span class="n">strings</span> <span class="s">&#34;Hello!&#34;</span>
    <span class="n">string2</span> <span class="ow">=</span> <span class="n">push_string</span> <span class="n">strings</span> <span class="s">&#34;Goodbye.&#34;</span>

    <span class="c1">// We have to pass `strings` to every function in our call stack which needs it</span>
    <span class="n">append_with_separator</span> <span class="n">strings</span> <span class="n">string1</span> <span class="s">&#34; &#34;</span> <span class="n">string2</span>

<span class="nf">run_example</span> <span class="p">()</span> <span class="ow">=</span>
    <span class="k">mut</span> <span class="n">context</span> <span class="ow">=</span> <span class="kt">Strings</span> <span class="p">(</span><span class="kt">Vec</span><span class="o">.</span><span class="n">new</span> <span class="p">())</span>
    <span class="n">example</span> <span class="o">!</span><span class="n">context</span>
</code></pre></div><p>Using a state effect essentially threads through the context automatically:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">type</span> <span class="kt">Strings</span> <span class="ow">=</span> <span class="n">vec</span><span class="o">:</span> <span class="kt">Vec</span> <span class="kt">String</span>
<span class="k">type</span> <span class="kt">StringKey</span> <span class="ow">=</span> <span class="n">index</span><span class="o">:</span> <span class="kt">Usz</span>

<span class="nf">push_string</span> <span class="p">(</span><span class="n">string</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span><span class="o">:</span> <span class="kt">StringKey</span> <span class="k">can</span> <span class="kt">Use</span> <span class="kt">Strings</span> <span class="ow">=</span>
    <span class="k">mut</span> <span class="n">strings</span> <span class="ow">=</span> <span class="n">get</span> <span class="p">()</span> <span class="o">:</span> <span class="kt">Strings</span>
    <span class="n">key</span> <span class="ow">=</span> <span class="kt">StringKey</span> <span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">len</span> <span class="p">())</span>
    <span class="n">strings</span><span class="o">.</span><span class="n">push</span> <span class="n">string</span>
    <span class="c1">// We could modify `Use a` to give mutable references or</span>
    <span class="c1">// use it via `Use !Strings` but for the sake of example</span>
    <span class="c1">// we just make sure to `set` here when mutating `strings`.</span>
    <span class="n">set</span> <span class="n">strings</span>
    <span class="n">key</span>

<span class="nf">get_string</span> <span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="kt">StringKey</span><span class="p">)</span><span class="o">:</span> <span class="kt">String</span> <span class="k">can</span> <span class="kt">Use</span> <span class="kt">Strings</span> <span class="ow">=</span>
    <span class="n">strings</span> <span class="ow">=</span> <span class="n">get</span> <span class="p">()</span> <span class="o">:</span> <span class="kt">Strings</span>
    <span class="n">strings</span><span class="o">.</span><span class="n">get</span> <span class="n">key</span> <span class="o">|&gt;</span> <span class="n">unwrap</span>

<span class="nf">append_with_separator</span> <span class="p">(</span><span class="n">string1_key</span> <span class="n">separator</span> <span class="n">string2_key</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">can</span> <span class="kt">Use</span> <span class="kt">Strings</span> <span class="ow">=</span>
    <span class="n">string1</span> <span class="ow">=</span> <span class="n">get_string</span> <span class="n">string1_key</span>
    <span class="n">string2</span> <span class="ow">=</span> <span class="n">get_string</span> <span class="n">string2_key</span>
    <span class="n">push_string</span> <span class="p">(</span><span class="n">string1</span> <span class="o">++</span> <span class="n">separator</span> <span class="o">++</span> <span class="n">string2</span><span class="p">)</span>

<span class="nf">example</span> <span class="p">()</span> <span class="k">can</span> <span class="kt">Use</span> <span class="kt">Strings</span> <span class="ow">=</span>
    <span class="n">string1</span> <span class="ow">=</span> <span class="n">push_string</span> <span class="s">&#34;Hello!&#34;</span>
    <span class="n">string2</span> <span class="ow">=</span> <span class="n">push_string</span> <span class="s">&#34;Goodbye.&#34;</span>
    <span class="c1">// No need to pass `strings` manually</span>
    <span class="n">append_with_separator</span> <span class="n">string1</span> <span class="s">&#34; &#34;</span> <span class="n">string2</span>

<span class="nf">run_example</span> <span class="p">()</span> <span class="ow">=</span>
    <span class="n">context</span> <span class="ow">=</span> <span class="kt">Strings</span> <span class="p">(</span><span class="kt">Vec</span><span class="o">.</span><span class="n">new</span> <span class="p">())</span>
    <span class="n">example</span> <span class="p">()</span> <span class="k">with</span> <span class="n">state</span> <span class="n">context</span>
</code></pre></div><p>From the above we can see we now have to call <code>get</code> or <code>set</code> to access <code>strings</code>
in the primitive operations <code>push_string</code> and <code>get_string</code>, but we no longer have
to explicitly pass around <code>strings</code> in code that just uses these primitive operations.
Generally speaking, this trade-off works well for libraries and abstractions which
will usually completely wrap these operations, eliminating the need for code using
these libraries to care about the internal details of how context objects are passed around.</p>
<p>This pattern pops up in quite a few places. Using a <code>Use a</code> effect locks us to passing
around a particular context type but we can also abstract the functions we need into
an interface. If the interface requires an internal context to implement it will be
automatically passed around with the effect handler. This leads us into the next point:</p>
<h3 id="as-a-substitute-for-globals">As a substitute for globals</h3>
<p>There are a few interfaces programmers may often think of as stateless but actually
require passing around state, often by global values for convenience. Some examples
of this are generating random numbers or simply allocating memory.</p>
<p>Let&rsquo;s consider an API for random numbers:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="kt">Prng</span><span class="o">.</span><span class="n">new</span> <span class="p">()</span><span class="o">:</span> <span class="kt">Prng</span> <span class="ow">=</span> <span class="o">...</span>

<span class="c1">// Return a random byte</span>
<span class="kt">Prng</span><span class="o">.</span><span class="n">random</span> <span class="o">!</span><span class="n">self</span><span class="o">:</span> <span class="kt">U8</span> <span class="ow">=</span> <span class="o">...</span>
</code></pre></div><p>We would have to require users to explicitly thread through the Prng object through their
program just to use random numbers for this API. This is perhaps a mild inconvenience but
it scales with the size of the program and is notable in that random numbers are usually
a small implementation detail to the program logic. Why should such a small implementation
detail cost so much to the terseness of the program? If we want to avoid this, we may make
the Prng a global, which many languages and libraries do, but this comes with the usual
downsides of globals - most notably requiring the object to be thread safe. If we make
it an effect like the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Random</span> <span class="k">with</span>
    <span class="c1">// Return a random byte</span>
    <span class="n">random</span><span class="o">:</span> <span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="kt">U8</span>
</code></pre></div><p>We gain the ability to thread it through a program mostly for free
(users must still explicitly initialize it somewhere up the call stack with a handler).
Plus, if we later decide we want to use <code>/dev/urandom</code> or some other source of random
numbers instead of the Prng object, we only need to swap out the effect handler. Nothing
else in the call stack needs to be changed.</p>
<p>Similarly, let&rsquo;s consider an <code>Allocate</code> effect:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="k">effect</span> <span class="kt">Allocate</span> <span class="k">with</span>
    <span class="n">allocate</span><span class="o">:</span> <span class="p">(</span><span class="n">size</span><span class="o">:</span> <span class="kt">Usz</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="kt">Alignment</span> <span class="ow">-&gt;</span> <span class="kt">Ptr</span> <span class="n">a</span>
    <span class="n">free</span><span class="o">:</span> <span class="kt">Ptr</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="kt">Unit</span>

<span class="c1">// example usage</span>
<span class="kt">Box</span><span class="o">.</span><span class="n">new</span> <span class="p">(</span><span class="n">elem</span><span class="o">:</span> <span class="n">a</span><span class="p">)</span><span class="o">:</span> <span class="kt">Box</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">Allocate</span> <span class="ow">=</span>
    <span class="o">...</span>
</code></pre></div><p>Such an effect would let us swap how we perform allocations by adding a different effect
handler for it somewhere up the call stack. We could use the global allocator for most calls,
then in a tight loop swap out each allocation in that loop with an arena allocator by just
adding a handler over the loop body.</p>
<p>I could go on with more examples of this (parsers, build systems, &hellip;) but I think
you get the gist.</p>
<h3 id="writing-in-a-direct-style">Writing in a Direct Style</h3>
<p>As a small note, effects being things that are thrown/performed rather than dedicated
values does often enable us to write in a more direct style compared to the alternative.</p>
<p>Exceptions are the easy example here, but just know this also applies to asynchronous
functions with <code>Future&lt;T&gt;</code> values or other types that are usually some wrapped effect.</p>
<p>So without exceptions we may use an error union or optional value like <code>Maybe t</code> which can be
<code>Some t</code> or <code>None</code>. If we have several computations returning results, we&rsquo;ll need
to <code>map</code> the <code>Some</code> value in-between steps:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="c1">// Imagine we have:</span>
<span class="nf">try_get_line_from_stdin</span> <span class="p">()</span><span class="o">:</span> <span class="kt">Maybe</span> <span class="kt">String</span> <span class="k">can</span> <span class="kt">IO</span> <span class="ow">=</span> <span class="o">...</span>
<span class="nf">try_parse</span> <span class="p">(</span><span class="n">s</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span><span class="o">:</span> <span class="kt">Maybe</span> <span class="kt">U32</span> <span class="ow">=</span> <span class="o">...</span>

<span class="c1">// read an integer from stdin, returning that value doubled</span>
<span class="nf">call_failable_functions</span> <span class="p">()</span><span class="o">:</span> <span class="kt">Maybe</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">IO</span> <span class="ow">=</span>
    <span class="n">try_get_line_from_stdin</span> <span class="p">()</span> <span class="o">|&gt;.</span><span class="n">and_then</span> <span class="k">fn</span> <span class="n">line</span> <span class="ow">-&gt;</span>
        <span class="n">try_parse</span> <span class="n">line</span> <span class="o">|&gt;.</span><span class="n">map</span> <span class="k">fn</span> <span class="n">x</span> <span class="ow">-&gt;</span>
            <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div><p>This is cumbersome enough languages like Rust provide syntax-sugar like <code>?</code>
to automatically return error values and focus on the good path. That isn&rsquo;t
needed with effects though. The direct approach just works:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="c1">// Now imagine we have:</span>
<span class="nf">get_line_from_stdin</span> <span class="p">()</span><span class="o">:</span> <span class="kt">String</span> <span class="k">can</span> <span class="kt">Fail</span><span class="p">,</span> <span class="kt">IO</span> <span class="ow">=</span> <span class="o">...</span>
<span class="nf">parse</span> <span class="p">(</span><span class="n">s</span><span class="o">:</span> <span class="kt">String</span><span class="p">)</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Fail</span> <span class="ow">=</span> <span class="o">...</span>

<span class="c1">// read an integer from stdin, returning that value doubled</span>
<span class="nf">call_failable_functions</span> <span class="p">()</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Fail</span> <span class="ow">=</span>
    <span class="n">line</span> <span class="ow">=</span> <span class="n">get_line_from_stdin</span> <span class="p">()</span>
    <span class="n">x</span> <span class="ow">=</span> <span class="n">parse</span> <span class="n">line</span>
    <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div><p>If we need to go off the good path we can just apply a handler:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="nf">call_failable_functions</span> <span class="p">()</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Fail</span> <span class="ow">=</span>
    <span class="c1">// get_line_from_stdin&#39;s Fail effect is now handled by `default` which returns &#34;42&#34; instead of failing</span>
    <span class="n">line</span> <span class="ow">=</span> <span class="n">get_line_from_stdin</span> <span class="p">()</span> <span class="k">with</span> <span class="n">default</span> <span class="s">&#34;42&#34;</span>
    <span class="n">x</span> <span class="ow">=</span> <span class="n">parse</span> <span class="n">line</span>
    <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>
</code></pre></div><p>Compared to error unions we never have to wrap our data in <code>Some</code>/<code>Ok</code> and we don&rsquo;t
have to worry about error types not composing well either:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="c1">// Now imagine we have:</span>
<span class="kt">LibraryA</span><span class="o">.</span><span class="n">foo</span> <span class="p">()</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Throw</span> <span class="kt">LibraryA</span><span class="o">.</span><span class="kt">Error</span> <span class="ow">=</span> <span class="o">...</span>
<span class="kt">LibraryB</span><span class="o">.</span><span class="n">bar</span> <span class="p">()</span><span class="o">:</span> <span class="kt">U32</span> <span class="k">can</span> <span class="kt">Throw</span> <span class="kt">LibraryB</span><span class="o">.</span><span class="kt">Error</span> <span class="ow">=</span> <span class="o">...</span>

<span class="k">type</span> <span class="kt">MyError</span> <span class="ow">=</span> <span class="n">message</span><span class="o">:</span> <span class="kt">String</span>

<span class="c1">// Composing the different error types just works</span>
<span class="nf">my_function</span> <span class="p">()</span><span class="o">:</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">Throw</span> <span class="kt">LibraryA</span><span class="o">.</span><span class="kt">Error</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">LibraryB</span><span class="o">.</span><span class="kt">Error</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">MyError</span> <span class="ow">=</span>
    <span class="n">x</span> <span class="ow">=</span> <span class="kt">LibraryA</span><span class="o">.</span><span class="n">foo</span> <span class="p">()</span>
    <span class="n">y</span> <span class="ow">=</span> <span class="kt">LibraryB</span><span class="o">.</span><span class="n">bar</span> <span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">then</span>
        <span class="n">throw</span> <span class="p">(</span><span class="kt">MyError</span> <span class="s">&#34;The results of `foo` and `bar` are too small&#34;</span><span class="p">)</span>
</code></pre></div><p>And if it gets too cumbersome to type out all those <code>Throw</code> clauses we can make a type alias
for the effects we want to handle:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="kt">AllErrors</span> <span class="ow">=</span> <span class="k">can</span> <span class="kt">Throw</span> <span class="kt">LibraryA</span><span class="o">.</span><span class="kt">Error</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">LibraryB</span><span class="o">.</span><span class="kt">Error</span><span class="p">,</span> <span class="kt">Throw</span> <span class="kt">MyError</span>

<span class="nf">my_function</span> <span class="p">()</span><span class="o">:</span> <span class="kt">Unit</span> <span class="k">can</span> <span class="kt">AllErrors</span> <span class="ow">=</span>
    <span class="n">x</span> <span class="ow">=</span> <span class="kt">LibraryA</span><span class="o">.</span><span class="n">foo</span> <span class="p">()</span>
    <span class="n">y</span> <span class="ow">=</span> <span class="kt">LibraryB</span><span class="o">.</span><span class="n">bar</span> <span class="p">()</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="k">then</span>
        <span class="n">throw</span> <span class="p">(</span><span class="kt">MyError</span> <span class="s">&#34;The results of `foo` and `bar` are too small&#34;</span><span class="p">)</span>
</code></pre></div><p>You can think of this as being similar to using an anonymous union type for error returns.
We don&rsquo;t need to define explicit wrappers to combine all the errors we use as with tagged
unions, and different error types compose naturally into the union. This also means if a
library <code>can Throw String</code>, and our code also <code>can Throw String</code>, these will combine into
just one <code>can Throw String</code> effect. If we want to keep them separate we need to use a wrapper
type like <code>MyError</code> above.</p>
<hr>
<h2 id="guaranteeing-purity">Guaranteeing Purity</h2>
<p>Most languages with effect handlers (barring perhaps only OCaml) also use effects wherever
side-effects may occur. You may have noticed the <code>can Print</code> or <code>can IO</code> on previous examples,
and it&rsquo;s true - you can&rsquo;t use side-effects in Ante without marking that the function may perform
them<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>. Setting aside the cases when <code>IO</code> or print outs are redirected or used for mocking,
these effects are usually handled in <code>main</code> automatically - so what benefit does it actually
provide by making programmers mark these functions?</p>
<p>For one, a number of functions actually require other non-side-effectful (ie. pure) functions
as input. When spawning threads for example, we can&rsquo;t allow the spawning thread to call into
handlers owned by our thread:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ante" data-lang="ante"><span class="c1">// Spawn all the given functions as threads and wait until they complete</span>
<span class="nf">spawn_all</span> <span class="p">(</span><span class="n">functions</span><span class="o">:</span> <span class="kt">Vec</span> <span class="p">(</span><span class="kt">Unit</span> <span class="ow">-&gt;</span> <span class="n">a</span> <span class="n">pure</span><span class="p">))</span><span class="o">:</span> <span class="kt">Vec</span> <span class="n">a</span> <span class="k">can</span> <span class="kt">IO</span> <span class="ow">=</span> <span class="o">...</span>
</code></pre></div><p>There is also a technique for concurrency called Software Transactional Memory (STM) which
requires pure functions. It works by running many functions simultaneously and if a value is
ever mutated out from under one thread while it was performing a transaction, it just restarts
that transaction. For the curious, there&rsquo;s a proof of concept implementation of it in Effekt
<a href="https://github.com/effekt-community/effekt-stm/blob/main/stm.effekt">here</a>.</p>
<h3 id="replayability">Replayability</h3>
<p>Another neat aspect of purity is that it can give you replayability similar to the <code>rr</code> debugging
utility. This is the tech needed for deterministic network replication and log structured backups
used in databases and videogame networking.</p>
<p>To implement this you would need two handlers: <code>record</code> and <code>replay</code> which handle the top-level
effect emitted by <code>main</code>. In most languages this is named <code>IO</code>. <code>record</code> would record that the
effect occurred, re-raise it to be handled by the built-in <code>IO</code> handler, and record its result.
Then, on another run <code>replay</code> would handle <code>IO</code> and use the results from the effect log instead
of actually performing them. A particularly smart language could even <code>record</code> by default in
debug builds to always get deterministic debugging!</p>
<h3 id="capability-based-security">Capability-based Security</h3>
<p>The requirement to include all unhandled effects as part of the type signature of a function
helps greatly when auditing the security of libraries. When you call a function
<code>get_pi: Unit -&gt; F64</code> you know that it isn&rsquo;t doing any sneaky IO in the background. If that
library is later updated to <code>get_pi: Unit -&gt; F64 can IO</code> you know something suspicious is
probably happening, and you&rsquo;ll get an error in your code as long as the function you&rsquo;re calling
<code>get_pi</code> in doesn&rsquo;t already require the <code>IO</code> effect<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup><sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>. This has parallels with <a href="https://joeduffyblog.com/2015/11/10/objects-as-secure-capabilities/">Capability
Based Security</a>
(bonus paper <a href="https://arxiv.org/abs/2005.11444">Designing with Static Capabilities and Effects</a>)
where we must pass around capabilities like <code>fs: FileSystem</code> as explicit objects and only
functions with these objects can access the file system. With algebraic effects it works similarly
except the functions declare effects instead of taking capability parameters. There is a downside
to the effect approach though, and its the same one mentioned above: since effects are automatically
threaded through your program you won&rsquo;t get an error if a function like <code>get_pi</code> is updated to
require <code>IO</code> if your function also already requires that effect. This can crop up anywhere
effects are used. E.g. with a <code>Fail</code> effect if a library function can&rsquo;t <code>Fail</code> but then was
updated to possibly <code>Fail</code>, it&rsquo;ll propagate upward to your existing <code>Fail</code> handler if used in
one of your functions that also can <code>Fail</code>. This may be fine but it may also be unintended depending
on the program. For example, perhaps a user may have preferred to handle it by providing a default value.</p>
<hr>
<p>Whew! That was a lot, but we made it through. Obviously this post focused on the positives of effects
and why I think they&rsquo;re going to be much more pervasive in the future, but there are negatives as well.
Aside from the accidental handling of effects issue mentioned above, the main downside with effects has
traditionally been efficiency concerns, although it should be said that compilation output of effects has improved
greatly in recent years. Most languages with algebraic effects will optimize &ldquo;tail-resumptive&rdquo; effects
(any effect where the last thing the handler does is call <code>resume</code>) into normal closure calls. This is great
because this is already most effects in practice (citation needed - although almost all the examples in this blog
post fit in this category! Exceptions being the only, <em>ahem</em>, exception here since they do not <code>resume</code> at all).
Different languages also have their own strategies for optimizing the remaining
effect handlers: <a href="https://koka-lang.github.io/koka/doc/index.html">Koka</a> uses
<a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2021/08/genev-icfp21.pdf">evidence passing</a>
and bubbles up effects to handlers to compile to C without a runtime, <a href="https://antelang.org/">Ante</a> and
<a href="https://github.com/ocaml-multicore/ocaml-effects-tutorial">OCaml</a> limit <code>resume</code> to only being called
at most once which precludes some effects like non-determinism but simplifies resource handling and
allows the internal continuations to be implemented more efficiently (e.g. via segmented stacks), and
<a href="https://effekt-lang.org/">Effekt</a> specializes handlers out of the program completely<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>!</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>The &ldquo;algebraic&rdquo; in algebraic effects is mostly a vestigial term. Using &ldquo;effect handlers&rdquo; is probably more accurate but I&rsquo;ll be referring to these mostly as algebraic effects since that is the term most users are familiar with. Also I think it is confusing to say &ldquo;effect handlers&rdquo; when talking about the effect itself and not just the handler.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>This definition of <code>state</code> completely ignores ownership rules. We&rsquo;d need a <code>Copy a</code> restriction for a real implementation but I didn&rsquo;t want to get side-tracked explaining ownership and traits in this post since it isn&rsquo;t relevant for effects in general. Most languages with algebraic effects allow pervasive sharing of values. Ante with its ownership semantics derived from Rust&rsquo;s is a bit of a black sheep here.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>The compiler can&rsquo;t check <code>extern</code> definitions for you, so the type definitions on those have to be trusted. There is also a (planned) way to perform an <code>IO</code> effect only when compiling in debug mode to allow debug printouts while still maintaining effect safety on release mode.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>This is one reason why it&rsquo;s usually preferable to declare the minimum amount of effects. Like saying your function <code>can Print</code> rather than bringing in all of <code>can IO</code>. If you don&rsquo;t know what the minimal set is, type inference can figure it out for you.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>The addition of a new effect to <code>get_pi</code> would also break semantic versioning so it can&rsquo;t be snuck into a bugfix version.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>This comes with the limitation that most functions are second-class but you can still get first-class functions by boxing them and switching to a pay-as-you-go approach. See <a href="https://effekt-lang.org/tour/captures">the docs</a> as well as <a href="https://dl.acm.org/doi/10.1145/3527320">this paper</a>.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

                        </div>
                        
                        

                    </div>
                    

                    

                    
                    <div class="col-md-3 right-float"/>

                    

                </div>
                

            </div>
            
        </div>
        

        <footer id="footer">
    <div class="container">

        

        <div class="col-md-4 col-sm-6">

            
            <h4>Recent posts</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://antelang.org/blog/safe_shared_mutability2/">
                          
                            <img src="/img/banners/antelope_flowers_cropped.jpg" class="img-responsive" alt="More on Safe, Aliasable Mutability with Unboxed Types">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://antelang.org/blog/safe_shared_mutability2/">More on Safe, Aliasable Mutability with Unboxed Types</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://antelang.org/blog/why_effects/">
                          
                            <img src="/img/banners/lanterns.jpg" class="img-responsive" alt="Why Algebraic Effects?">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://antelang.org/blog/why_effects/">Why Algebraic Effects?</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://antelang.org/blog/simplification_through_addition/">
                          
                            <img src="/img/banners/antelope_canyon_cropped.jpg" class="img-responsive" alt="Simplification Through Addition">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://antelang.org/blog/simplification_through_addition/">Simplification Through Addition</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
            

        </div>
        

        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-right">
              Template by <a href="https://bootstrapious.com/p/universal-business-e-commerce-template">Bootstrapious</a>.
              

              Ported to Hugo by <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>.
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="https://antelang.org/js/front.js"></script>


<script src="https://antelang.org/js/owl.carousel.min.js"></script>


  </body>
</html>
